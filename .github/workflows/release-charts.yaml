name: Release Charts

on:
  push:
    branches: [main]
    paths:
      - "**/helm/Chart.yaml"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username "${{ github.actor }}" --password-stdin

      - name: Package and push charts
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          for module_dir in */; do
            module="${module_dir%/}"
            chart_dir="${module}/helm"

            if [ ! -f "${chart_dir}/Chart.yaml" ]; then
              continue
            fi

            chart_name=$(yq '.name' "${chart_dir}/Chart.yaml")
            chart_version=$(yq '.version' "${chart_dir}/Chart.yaml")

            echo "::group::${chart_name} v${chart_version}"

            # Add dependency repos and build
            dep_count=$(yq '.dependencies | length' "${chart_dir}/Chart.yaml")
            if [ "$dep_count" != "null" ] && [ "$dep_count" != "0" ]; then
              for i in $(seq 0 $((dep_count - 1))); do
                dep_repo=$(yq ".dependencies[${i}].repository" "${chart_dir}/Chart.yaml")
                if [ -n "$dep_repo" ] && [ "$dep_repo" != "null" ]; then
                  dep_name="dep-$(echo "$dep_repo" | md5sum | cut -d' ' -f1)"
                  helm repo add "$dep_name" "$dep_repo" 2>/dev/null || true
                fi
              done
              helm dependency build "${chart_dir}"
            fi

            helm package "${chart_dir}" -d .packages

            echo "Pushing ${chart_name}:${chart_version} to ghcr.io/${REPO_OWNER}/charts..."
            helm push ".packages/${chart_name}-${chart_version}.tgz" "oci://ghcr.io/${REPO_OWNER}/charts"

            echo "::endgroup::"
          done
